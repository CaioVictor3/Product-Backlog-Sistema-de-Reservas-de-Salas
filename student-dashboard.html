<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reservas de Salas - Aluno</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
        }
        .student-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        .btn-logout {
            margin-left: auto;
        }
        .card {
            border-radius: 0.75rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .form-control, .form-select {
            border-radius: 0.5rem;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        .btn-primary {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        .reservation-card {
            border-left: 4px solid #28a745;
        }
        .reservation-card.pending {
            border-left-color: #ffc107;
        }
        .reservation-card.cancelled {
            border-left-color: #dc3545;
        }
        .status-badge {
            font-size: 0.875rem;
        }
        .no-reservations {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .room-info {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-calendar-check me-2"></i>
                Sistema de Reservas
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="bi bi-person-circle me-1"></i>
                    <span id="student-name">Aluno</span>
                    <span class="badge student-badge ms-2">Aluno</span>
                </span>
                <button class="btn btn-outline-light btn-sm btn-logout" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    Sair
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="studentTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="new-reservation-tab" data-bs-toggle="tab" data-bs-target="#new-reservation" type="button" role="tab">
                    <i class="bi bi-plus-circle me-2"></i>
                    Nova Reserva
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="my-reservations-tab" data-bs-toggle="tab" data-bs-target="#my-reservations" type="button" role="tab">
                    <i class="bi bi-list-ul me-2"></i>
                    Minhas Reservas
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-4" id="studentTabsContent">
            <!-- New Reservation Tab -->
            <div class="tab-pane fade show active" id="new-reservation" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-plus me-2"></i>
                                    Fazer Nova Reserva
                                </h5>
                            </div>
                            <div class="card-body">
                                <form id="reservationForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="roomSelect" class="form-label">
                                                <i class="bi bi-door-open me-1"></i>
                                                Sala
                                            </label>
                                            <select class="form-select" id="roomSelect" required>
                                                <option value="">Selecione uma sala</option>
                                            </select>
                                            <div id="roomInfo" class="room-info" style="display: none;">
                                                <small class="text-muted" id="roomDetails"></small>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="reservationDate" class="form-label">
                                                <i class="bi bi-calendar3 me-1"></i>
                                                Data
                                            </label>
                                            <input type="date" class="form-control" id="reservationDate" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="startTime" class="form-label">
                                                <i class="bi bi-clock me-1"></i>
                                                Horário de Início
                                            </label>
                                            <input type="time" class="form-control" id="startTime" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="endTime" class="form-label">
                                                <i class="bi bi-clock-fill me-1"></i>
                                                Horário de Término
                                            </label>
                                            <input type="time" class="form-control" id="endTime" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="reservationPurpose" class="form-label">
                                            <i class="bi bi-chat-text me-1"></i>
                                            Finalidade da Reserva
                                        </label>
                                        <textarea class="form-control" id="reservationPurpose" rows="3" placeholder="Descreva brevemente o motivo da reserva..."></textarea>
                                    </div>
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-circle me-2"></i>
                                            Fazer Reserva
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Informações Importantes
                                </h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="bi bi-clock text-primary me-2"></i>
                                        <small>Reservas devem ser feitas com pelo menos 1 hora de antecedência</small>
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-calendar text-primary me-2"></i>
                                        <small>Máximo de 4 horas por reserva</small>
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-person text-primary me-2"></i>
                                        <small>Reservas são limitadas a 1 por dia por aluno</small>
                                    </li>
                                    <li class="mb-0">
                                        <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                        <small>Reservas não utilizadas serão canceladas automaticamente</small>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Reservations Tab -->
            <div class="tab-pane fade" id="my-reservations" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5>
                        <i class="bi bi-list-ul me-2"></i>
                        Minhas Reservas
                    </h5>
                    <button class="btn btn-outline-primary" onclick="loadMyReservations()">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        Atualizar
                    </button>
                </div>

                <div id="my-reservations-list">
                    <!-- Reservations will be loaded here -->
                </div>

                <div id="no-my-reservations" class="no-reservations" style="display: none;">
                    <i class="bi bi-calendar-x display-1 text-muted"></i>
                    <h4 class="mt-3">Nenhuma reserva encontrada</h4>
                    <p class="text-muted">Você ainda não fez nenhuma reserva.</p>
                    <button class="btn btn-primary" onclick="document.getElementById('new-reservation-tab').click()">
                        <i class="bi bi-plus-circle me-2"></i>
                        Fazer Primeira Reserva
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentStudent = null;

        // Initialize data and check authentication
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            checkStudentAuth();
            loadRooms();
            loadMyReservations();
            setupFormValidation();
        });

        // Initialize mock data in localStorage (same as in other files)
        function initializeData() {
            // Check if data already exists
            if (localStorage.getItem('users') && localStorage.getItem('rooms') && localStorage.getItem('reservations')) {
                return;
            }

            // Mock Users Data
            const users = [
                { id: 1, name: 'João Silva', email: 'joao@email.com', type: 'admin', password: 'admin123' },
                { id: 2, name: 'Maria Santos', email: 'maria@email.com', type: 'student', password: 'student123' },
                { id: 3, name: 'Pedro Costa', email: 'pedro@email.com', type: 'student', password: 'student123' },
                { id: 4, name: 'Ana Oliveira', email: 'ana@email.com', type: 'student', password: 'student123' },
                { id: 5, name: 'Carlos Lima', email: 'carlos@email.com', type: 'student', password: 'student123' }
            ];

            // Mock Rooms Data
            const rooms = [
                { id: 1, name: 'Sala 101', capacity: 30, location: 'Bloco A' },
                { id: 2, name: 'Sala 102', capacity: 25, location: 'Bloco A' },
                { id: 3, name: 'Laboratório de Informática', capacity: 20, location: 'Bloco B' },
                { id: 4, name: 'Auditório Principal', capacity: 100, location: 'Bloco C' },
                { id: 5, name: 'Sala de Reuniões', capacity: 15, location: 'Bloco A' }
            ];

            // Mock Reservations Data
            const reservations = [
                { 
                    id: 1, 
                    studentId: 2, 
                    roomId: 1, 
                    date: '2024-01-15', 
                    startTime: '08:00', 
                    endTime: '10:00',
                    status: 'confirmed',
                    purpose: 'Estudo em grupo',
                    createdAt: '2024-01-10T10:30:00Z'
                },
                { 
                    id: 2, 
                    studentId: 3, 
                    roomId: 3, 
                    date: '2024-01-16', 
                    startTime: '14:00', 
                    endTime: '16:00',
                    status: 'confirmed',
                    purpose: 'Projeto de programação',
                    createdAt: '2024-01-11T09:15:00Z'
                },
                { 
                    id: 3, 
                    studentId: 4, 
                    roomId: 4, 
                    date: '2024-01-17', 
                    startTime: '19:00', 
                    endTime: '21:00',
                    status: 'pending',
                    purpose: 'Apresentação de trabalho',
                    createdAt: '2024-01-12T14:20:00Z'
                },
                { 
                    id: 4, 
                    studentId: 5, 
                    roomId: 2, 
                    date: '2024-01-18', 
                    startTime: '10:00', 
                    endTime: '12:00',
                    status: 'confirmed',
                    purpose: 'Reunião de grupo',
                    createdAt: '2024-01-13T11:45:00Z'
                },
                { 
                    id: 5, 
                    studentId: 2, 
                    roomId: 5, 
                    date: '2024-01-19', 
                    startTime: '15:00', 
                    endTime: '17:00',
                    status: 'cancelled',
                    purpose: 'Estudo individual',
                    createdAt: '2024-01-14T08:30:00Z'
                }
            ];

            // Store data in localStorage
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('rooms', JSON.stringify(rooms));
            localStorage.setItem('reservations', JSON.stringify(reservations));
        }

        // Check if user is logged in as student
        function checkStudentAuth() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            if (!currentUser || currentUser.type !== 'student') {
                alert('Acesso negado. Apenas alunos podem acessar esta página.');
                window.location.href = 'login.html';
                return false;
            }
            
            currentStudent = currentUser;
            document.getElementById('student-name').textContent = currentUser.name;
            return true;
        }

        // Load rooms for selection
        function loadRooms() {
            const rooms = JSON.parse(localStorage.getItem('rooms') || '[]');
            const roomSelect = document.getElementById('roomSelect');
            
            roomSelect.innerHTML = '<option value="">Selecione uma sala</option>';
            
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.id;
                option.textContent = `${room.name} - ${room.location}`;
                roomSelect.appendChild(option);
            });
        }

        // Setup form validation and room info display
        function setupFormValidation() {
            const roomSelect = document.getElementById('roomSelect');
            const roomInfo = document.getElementById('roomInfo');
            const roomDetails = document.getElementById('roomDetails');
            const reservationDate = document.getElementById('reservationDate');
            const startTime = document.getElementById('startTime');
            const endTime = document.getElementById('endTime');

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            reservationDate.min = today;

            // Show room info when selected
            roomSelect.addEventListener('change', function() {
                if (this.value) {
                    const rooms = JSON.parse(localStorage.getItem('rooms') || '[]');
                    const selectedRoom = rooms.find(room => room.id == this.value);
                    
                    if (selectedRoom) {
                        roomDetails.textContent = `Capacidade: ${selectedRoom.capacity} pessoas | Local: ${selectedRoom.location}`;
                        roomInfo.style.display = 'block';
                    }
                } else {
                    roomInfo.style.display = 'none';
                }
            });

            // Validate time range
            startTime.addEventListener('change', function() {
                if (this.value && endTime.value) {
                    validateTimeRange();
                }
            });

            endTime.addEventListener('change', function() {
                if (this.value && startTime.value) {
                    validateTimeRange();
                }
            });
        }

        // Validate time range
        function validateTimeRange() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (startTime && endTime) {
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(`2000-01-01T${endTime}`);
                const diffHours = (end - start) / (1000 * 60 * 60);
                
                if (diffHours <= 0) {
                    alert('O horário de término deve ser posterior ao horário de início.');
                    document.getElementById('endTime').value = '';
                } else if (diffHours > 4) {
                    alert('A reserva não pode exceder 4 horas.');
                    document.getElementById('endTime').value = '';
                }
            }
        }

        // Handle reservation form submission
        document.getElementById('reservationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const roomId = parseInt(document.getElementById('roomSelect').value);
            const date = document.getElementById('reservationDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const purpose = document.getElementById('reservationPurpose').value;

            // Validate reservation
            if (!validateReservation(roomId, date, startTime, endTime)) {
                return;
            }

            // Create new reservation
            const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
            const newReservation = {
                id: reservations.length > 0 ? Math.max(...reservations.map(r => r.id)) + 1 : 1,
                studentId: currentStudent.id,
                roomId: roomId,
                date: date,
                startTime: startTime,
                endTime: endTime,
                status: 'pending',
                purpose: purpose || 'Sem descrição',
                createdAt: new Date().toISOString()
            };

            // Add to reservations
            reservations.push(newReservation);
            localStorage.setItem('reservations', JSON.stringify(reservations));

            // Show success message
            showSuccessMessage('Reserva criada com sucesso! Aguarde aprovação do administrador.');

            // Reset form
            document.getElementById('reservationForm').reset();
            document.getElementById('roomInfo').style.display = 'none';

            // Switch to my reservations tab
            document.getElementById('my-reservations-tab').click();
            loadMyReservations();
        });

        // Validate reservation
        function validateReservation(roomId, date, startTime, endTime) {
            const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
            
            // Check if student already has a reservation for this date
            const existingReservation = reservations.find(r => 
                r.studentId === currentStudent.id && 
                r.date === date && 
                r.status !== 'cancelled'
            );
            
            if (existingReservation) {
                alert('Você já possui uma reserva para esta data.');
                return false;
            }

            // Check if room is available for this time slot
            const conflictingReservation = reservations.find(r => 
                r.roomId === roomId && 
                r.date === date && 
                r.status !== 'cancelled' &&
                ((startTime >= r.startTime && startTime < r.endTime) ||
                 (endTime > r.startTime && endTime <= r.endTime) ||
                 (startTime <= r.startTime && endTime >= r.endTime))
            );
            
            if (conflictingReservation) {
                alert('A sala já está reservada para este horário.');
                return false;
            }

            // Check if reservation is at least 1 hour in advance
            const now = new Date();
            const reservationDateTime = new Date(`${date}T${startTime}`);
            const diffHours = (reservationDateTime - now) / (1000 * 60 * 60);
            
            if (diffHours < 1) {
                alert('Reservas devem ser feitas com pelo menos 1 hora de antecedência.');
                return false;
            }

            return true;
        }

        // Load and display student's reservations
        function loadMyReservations() {
            const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
            const rooms = JSON.parse(localStorage.getItem('rooms') || '[]');
            
            const myReservations = reservations.filter(r => r.studentId === currentStudent.id);
            const reservationsList = document.getElementById('my-reservations-list');
            const noReservationsDiv = document.getElementById('no-my-reservations');
            
            if (myReservations.length === 0) {
                reservationsList.innerHTML = '';
                noReservationsDiv.style.display = 'block';
                return;
            }
            
            noReservationsDiv.style.display = 'none';
            
            // Sort reservations by date and time (newest first)
            const sortedReservations = myReservations.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + a.startTime);
                const dateB = new Date(b.date + 'T' + b.startTime);
                return dateB - dateA;
            });
            
            reservationsList.innerHTML = sortedReservations.map(reservation => {
                const room = rooms.find(room => room.id === reservation.roomId);
                const statusClass = getStatusClass(reservation.status);
                const statusText = getStatusText(reservation.status);
                
                return `
                    <div class="card reservation-card ${reservation.status} mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="card-title mb-1">
                                        <i class="bi bi-door-open me-2"></i>
                                        ${room ? room.name : 'Sala não encontrada'}
                                    </h6>
                                    <p class="card-text text-muted mb-1">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        ${room ? room.location : ''}
                                    </p>
                                    <p class="card-text mb-1">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        ${formatDate(reservation.date)} - 
                                        <i class="bi bi-clock me-1"></i>
                                        ${reservation.startTime} às ${reservation.endTime}
                                    </p>
                                    ${reservation.purpose ? `<p class="card-text text-muted mb-0"><i class="bi bi-chat-text me-1"></i>${reservation.purpose}</p>` : ''}
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge ${statusClass} status-badge mb-2">
                                        ${statusText}
                                    </span>
                                    <br>
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>
                                        Criada em ${formatDateTime(reservation.createdAt)}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get status CSS class
        function getStatusClass(status) {
            switch (status) {
                case 'confirmed':
                    return 'bg-success';
                case 'pending':
                    return 'bg-warning text-dark';
                case 'cancelled':
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }

        // Get status text
        function getStatusText(status) {
            switch (status) {
                case 'confirmed':
                    return 'Confirmada';
                case 'pending':
                    return 'Pendente';
                case 'cancelled':
                    return 'Cancelada';
                default:
                    return 'Desconhecido';
            }
        }

        // Format date to Brazilian format
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // Format date and time to Brazilian format
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR');
        }

        // Show success message
        function showSuccessMessage(message) {
            const button = document.querySelector('#reservationForm button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check-circle me-2"></i>Reserva Criada!';
            button.classList.add('btn-success');
            button.classList.remove('btn-primary');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('btn-success');
                button.classList.add('btn-primary');
            }, 3000);
        }

        // Logout function
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
